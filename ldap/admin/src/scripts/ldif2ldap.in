#!/bin/sh

source ./DSSharedLib

libpath_add "@ldapsdk_libdir@"
libpath_add "@libdir@"
libpath_add "@nss_libdir@"
libpath_add "@libdir@/dirsrv/"

export LD_LIBRARY_PATH
SHLIB_PATH=$LD_LIBRARY_PATH
export SHLIB_PATH
PATH=$PATH:@ldaptool_bindir@:@ldaptool_bindir@

usage ()
{
    echo "Usage: ldif2ldap [-Z serverID] -D <bind dn> -w <password> -f <file>"
}

while getopts "Z:D:w:f:h" flag
do
    case $flag in
        Z) servid=$OPTARG;;
        D) args=$args" -D $OPTARG"
           binddn=$OPTARG;;
        w) args=$args" -w $OPTARG"
           passwd=$OPTARG;;
        f) args=$args" -f $OPTARG"
           input_file=$OPTARG;;
        h) usage
           exit 0;;
        ?) usage
           exit 1;;
    esac
done

if [ "$binddn" == "" ] || [ "$passwd" == "" ] || [ "$input_file" == "" ]
then 
    usage
    exit 1
fi

servid=$(get_server_id "@initconfigdir@" $servid)
if [ $? == 1 ]
then
    usage
    echo "You must supply a valid server instance identifier.  Use -Z to specify instance name"
    echo "Available instances: $servid"
    exit 1
fi

port=$(grep 'nsslapd-port' @instconfigdir@/slapd-$servid/dse.ldif | awk '{print $2}' )
host=$(grep 'nsslapd-localhost' @instconfigdir@/slapd-$servid/dse.ldif | awk '{print $2}' )

ldapmodify @ldaptool_opts@ -a -p $port -h $host $args
