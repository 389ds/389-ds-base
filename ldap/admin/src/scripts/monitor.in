#!/bin/sh

source ./DSSharedLib

libpath_add "@libdir@/dirsrv/"
libpath_add "@ldapsdk_libdir@"
libpath_add "@libdir@"
libpath_add "@nss_libdir@"

export LD_LIBRARY_PATH
SHLIB_PATH=$LD_LIBRARY_PATH
export SHLIB_PATH
PATH=$PATH:@ldaptool_bindir@:@ldaptool_bindir@

usage ()
{
    echo "Usage: monitor [ -Z serverID ] [ -b basedn ]"
}

while getopts "Z:b:h" flag
do
    case $flag in
        Z) servid=$OPTARG;;
        b) MDN=$OPTARG;;
        h) usage
           exit 0;;
        ?) usage
           exit 1;;
    esac
done

servid=$(get_server_id "@initconfigdir@" $servid)
if [ $? == 1 ]
then
    usage
    echo "You must supply a valid server instance identifier.  Use -Z to specify instance name"
    echo "Available instances: $servid"
    exit 1
fi

port=$(grep 'nsslapd-port' @instconfigdir@/slapd-$servid/dse.ldif | awk '{print $2}' )
host=$(grep 'nsslapd-localhost' @instconfigdir@/slapd-$servid/dse.ldif | awk '{print $2}' )

if [ -z $MDN ]
then
    MDN="cn=monitor";
fi

ldapsearch @ldaptool_opts@ -LLL -p $port -h $host -b "$MDN" -s base "objectClass=*"
