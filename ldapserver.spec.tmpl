# BEGIN COPYRIGHT BLOCK
# Copyright (C) 2005 Red Hat, Inc.
# All rights reserved.
# END COPYRIGHT BLOCK
Summary: @COMPANY-PRODUCT-NAME@
Name: @LCASE-COMPANY-NAME-NOSP@-ds
Version: @GEN-VERSION@
Release: 1.@PLATFORM@
License: GPL plus extensions
Group: System Environment/Daemons
URL: @COMPANY-URL@
Source0: %{name}-%{version}.tar.gz
BuildRoot: %{_builddir}/%{name}-root
BuildPreReq: perl, fileutils, make
# Without Autoreq: 0, rpmbuild finds all sorts of crazy
# dependencies that we don't care about, and refuses to install
Autoreq: 0
# Without Requires: something, rpmbuild will abort!
Requires: perl
Prefix: /opt/%{name}

%description
@COMPANY-PRODUCT-NAME@ is an LDAPv3 compliant server.

# prep and setup expect there to be a Source0 file
# in the SOURCES directory - it will be unpacked
# in the _builddir (not BuildRoot)
%prep
%setup -q

%build
# This will do a regular make build and make pkg
# including grabbing the admin server, setup, etc.
# The resultant zip files and setup program will
# be in ldapserver/pkg
# INSTDIR is relative to ldap/cm
# build the file structure to package under ldapserver/pkg
# instead of MM.DD/platform
# remove BUILD_DEBUG=optimize to build the debug version
# INTERNAL_BUILD=1 uses the internal, proprietary packages
# like setupsdk, adminsdk, admin server
# BUILD_MODE=int builds the Redhat branded product
BUILDMODE=@BUILD-MODE@
PLATFORM=@PLATFORM@
if [ $BUILDMODE = int ]; then
# brandDirectory makes the product use Redhat branded text and graphics
	make brandDirectory
fi
make INTERNAL_BUILD=1 BUILD_MODE=$BUILDMODE BUILD_JAVA_CODE=1 BUILD_DEBUG=optimize NO_INSTALLER_TAR_FILES=1 INSTDIR=../../pkg/$PLATFORM

%install
# all we do here is run setup -b to unpack the binaries
# into the BuildRoot
PLATFORM=@PLATFORM@
rm -rf $RPM_BUILD_ROOT
cd pkg/$PLATFORM
# the echo yes is for dsktune to continue
echo yes | ./setup -b $RPM_BUILD_ROOT/%{prefix}
# this is our setup script that sets up the initial
# server instances after installation
cd ../..
cp ldap/cm/newinst/setup $RPM_BUILD_ROOT/%{prefix}/setup

%clean
rm -rf $RPM_BUILD_ROOT

%files
# rather than listing individual files, we just package (and own)
# the entire ldapserver directory - if we change this to put
# files in different places, we won't be able to do this anymore
%defattr(-,root,root,-)
%{prefix}

%post
echo ""
if [ -z "$RPM_INSTALL_PREFIX" ]; then
	RPM_INSTALL_PREFIX=${prefix}
fi
echo "Please go to $RPM_INSTALL_PREFIX and run ./setup/setup"

%preun
if [ -z "$RPM_INSTALL_PREFIX" ]; then
	RPM_INSTALL_PREFIX=${prefix}
fi
cd $RPM_INSTALL_PREFIX
./uninstall -s -force

%changelog
* Tue Apr  5 2005 Rich Megginson <rmeggins@redhat.com> 7.1-1
- use platform specific packaging directory; add preun to do uninstall

* Fri Apr  1 2005 Rich Megginson <rmeggins@redhat.com> 7.1-1
- use setup -q to suppress tar output

* Tue Mar 29 2005 Richard Megginson <rmeggins@redhat.com> 7.1-1
- use INTERNAL_BUILD=1 for internal builds - change rev to 1

* Tue Mar  8 2005 Richard Megginson <rmeggins@redhat.com> 7.1-0
- use ${prefix} instead of /opt/ldapserver - prefix is defined as /opt/%{name}

* Thu Jan 20 2005 Richard Megginson <rmeggins@redhat.com>
- Initial build.


