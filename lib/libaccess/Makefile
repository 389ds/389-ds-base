#
# BEGIN COPYRIGHT BLOCK
# Copyright (C) 2001 Sun Microsystems, Inc. Used by permission.
# Copyright (C) 2005 Red Hat, Inc.
# All rights reserved.
# END COPYRIGHT BLOCK
#
#
# Makefile for libaccess.a
#
BUILD_ROOT=../..
MODULE=LibAccess
include $(BUILD_ROOT)/nsdefs.mk

OBJDEST=$(OBJDIR)/lib/libaccess
UTESTDEST=$(OBJDIR)/lib/libaccess/utest
LEX=flex

include $(BUILD_ROOT)/nsconfig.mk

MCC_INCLUDE += $(ADMINUTIL_INCLUDE)

ifeq ($(ARCH), WINNT)
LIBS=$(OBJDIR)/lib/libaccess.lib
CC=cl -nologo -MT
VALUES=$(OBJDEST)/values.h
else
VALUES=
LIBS=$(OBJDIR)/lib/libaccess.a
endif

all: $(OBJDEST) $(LIBS)

$(OBJDEST):
	mkdir -p $(OBJDEST)

$(UTESTDEST):
	mkdir -p $(UTESTDEST)

OSOBJS = 

OBJS=$(addprefix $(OBJDEST)/,	usi.o \
				nseframe.o \
				nsautherr.o \
				symbols.o \
                                acltools.o \
                                aclutil.o \
				aclcache.o \
				aclflush.o \
				authdb.o \
				method.o \
				ldapacl.o \
				register.o \
                                lasdns.o \
                                lasip.o \
                                lastod.o \
				usrcache.o \
				lasgroup.o \
				lasuser.o \
                                aclspace.o \
                                acl.tab.o \
                                acl.yy.o \
                                acleval.o \
				oneeval.o \
				access_plhash.o \
				aclerror.o \
                                $(OSOBJS) \
				)

MODULE_CFLAGS=-I$(BUILD_ROOT)/include -DACL_LIB_INTERNAL $(TESTFLAGS)

ifeq ($(LDAP_NO_LIBLCACHE),1)
MODULE_CFLAGS+=-DNO_LIBLCACHE
endif

LOCAL_DEPS = $(LDAPSDK_DEP)

$(LIBS): $(LOCAL_DEPS) $(OBJS)
	rm -f $@
	$(AR) $(OBJS)
	$(RANLIB) $@ 

include $(INCLUDE_DEPENDS)

#
# acl.tab.c acl.tab.h and acl.yy.c should not be generated by the build,
# they are checked in and should be pulled from the tree by
# default.  The following rules are provided in case the grammar or
# lexer needs changes.
#

#
# Right now it's best to run yacc on a Solaris machine because the
# /usr/lib/yaccpar makes the NT compiler happier.  It should work on
# other UNIX systems -- but that's what is checked in and tested.
#
yacc:
	$(YACC) -d acltext.y
	sed -f yy-sed y.tab.h > acl.tab.h
	sed -f yy-sed y.tab.c > acl.tab.cpp
	rm y.tab.h y.tab.c

#
# Flex generates a case insenitive lexer.  It also provides mechanisms
# that allow NSPR to replace it's standard IO routines.  The standard UNIX
# lex wants to use some stupid library!  One would think that lex could
# generate all the code it needs just like FLEX.
# 
flex: 
	$(LEX) -i aclscan.l
	sed -f yy-sed lex.yy.c > acl.yy.cpp
	rm lex.yy.c
